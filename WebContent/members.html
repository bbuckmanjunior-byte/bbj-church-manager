<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Church Directory - BBJ Church Manager</title>
  <link href="lib/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" id="brandLink" href="member-dashboard.html"><i class="bi bi-building"></i> BBJ Church</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="announcements.html"><i class="bi bi-megaphone-fill"></i> Announcements</a></li>
          <li class="nav-item"><a class="nav-link" href="events.html"><i class="bi bi-calendar-event-fill"></i> Events</a></li>
          <li class="nav-item"><a class="nav-link" href="sermons.html"><i class="bi bi-mic-fill"></i> Sermons</a></li>
          <li class="nav-item"><a class="nav-link active" href="members.html"><i class="bi bi-people-fill"></i> Members</a></li>
          <li class="nav-item"><a class="nav-link" href="logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1>üë• Church Directory</h1>
    </div>

    <div class="row mb-4">
      <div class="col-md-9">
        <input type="text" id="searchInput" class="form-control" placeholder="üîç Search members by name or phone...">
      </div>
      <div class="col-md-3">
        <button id="exportBtn" onclick="exportMembers()" class="btn btn-success w-100" style="display:none;">
          <i class="bi bi-download"></i> Export to Excel
        </button>
      </div>
    </div>

    <div id="membersList" class="row g-4">
      <div class="col-12 text-center" style="padding:2rem">
        <div class="loading">Loading members</div>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>&copy; 2026 BBJ Digital Church Manager. All rights reserved.</p>
  </div>

  <script src="lib/bootstrap/bootstrap.bundle.min.js"></script>
  <script>
    let isAdmin = false;
    
    // Fix navbar brand link based on admin status
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      isAdmin = urlParams.get('admin') === 'true';
      const brandLink = document.getElementById('brandLink');
      if (isAdmin) {
        brandLink.href = 'admin-dashboard.html';
      } else {
        brandLink.href = 'member-dashboard.html';
      }
      
      // Show/hide export button based on admin status
      const exportBtn = document.getElementById('exportBtn');
      if (isAdmin) {
        exportBtn.style.display = 'block';
      } else {
        exportBtn.style.display = 'none';
      }
    })();

    let allMembers = [];

    // Load members on page load
    LoadMembers();

    function LoadMembers() {
      const urlParams = new URLSearchParams(window.location.search);
      isAdmin = urlParams.get('admin') === 'true';
      const action = isAdmin ? 'admin_list' : 'list';

      fetch('members?action=' + action)
        .then(r => r.json())
        .then(data => {
          if (data.members) {
            allMembers = data.members;
            displayMembers(allMembers);
          } else {
            document.getElementById('membersList').innerHTML = '<div class="col-12 text-center alert alert-info">No members found</div>';
          }
        })
        .catch(e => {
          console.error(e);
          document.getElementById('membersList').innerHTML = '<div class="col-12 text-center alert alert-danger">Failed to load members</div>';
        });
    }

    function displayMembers(members) {
      const container = document.getElementById('membersList');
      if (members.length === 0) {
        container.innerHTML = '<div class="col-12 text-center alert alert-info">No members found</div>';
        return;
      }

      container.innerHTML = members.map(member => {
        const isAdminView = member.username !== undefined;
        return `
          <div class="col-md-6 col-lg-4">
            <div class="card">
              <div style="font-size:2rem;margin-bottom:0.5rem">üë§</div>
              <h3 style="margin-bottom:0.5rem">${member.first_name} ${member.last_name}</h3>
              ${member.phone ? `<p>üìû ${member.phone}</p>` : ''}
              ${isAdminView ? `
                <p>
                  <strong>Email:</strong> ${member.email}<br>
                  ${member.address ? `<strong>Address:</strong> ${member.address}<br>` : ''}
                  <strong>Role:</strong> <span class="badge ${member.role === 'admin' ? 'bg-danger' : 'bg-success'}">${member.role}</span>
                </p>
                ${isAdmin && member.role !== 'admin' ? `
                  <button onclick="deleteMember(${member.id})" class="btn btn-danger btn-sm mt-2">üóëÔ∏è Delete Member</button>
                ` : ''}
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function deleteMember(id) {
      if (confirm('Are you sure you want to delete this member? This action cannot be undone.')) {
        fetch('members', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: `action=delete&id=${id}`
        }).then(r => r.json()).then(j => {
          if (j.success) {
            alert('‚úì Member deleted');
            location.reload();
          } else {
            alert('‚úó Error: ' + (j.error || 'Unknown error'));
          }
        }).catch(e => alert('‚úó Error: ' + e.message));
      }
    }

    function exportMembers() {
      if (!isAdmin) {
        alert('Only admins can export members');
        return;
      }
      
      const exportBtn = document.getElementById('exportBtn');
      const originalText = exportBtn.innerHTML;
      exportBtn.disabled = true;
      exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Exporting...';
      
      fetch('export-members')
        .then(response => {
          if (!response.ok) {
            throw new Error('Export failed: ' + response.statusText);
          }
          return response.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'Members_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.xlsx';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          exportBtn.disabled = false;
          exportBtn.innerHTML = originalText;
          alert('‚úì Members exported successfully!');
        })
        .catch(error => {
          console.error('Export error:', error);
          exportBtn.disabled = false;
          exportBtn.innerHTML = originalText;
          alert('‚úó Error exporting members: ' + error.message);
        });
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allMembers.filter(m => {
        const name = (m.first_name + ' ' + m.last_name).toLowerCase();
        const phone = (m.phone || '').toLowerCase();
        return name.includes(searchTerm) || phone.includes(searchTerm);
      });
      displayMembers(filtered);
    });
  </script>
</body>
</html>
