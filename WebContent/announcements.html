<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Announcements - BBJ Church Manager</title>
  <link href="lib/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html"><i class="bi bi-building"></i> BBJ Church</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="announcements.html"><i class="bi bi-megaphone-fill"></i> Announcements</a></li>
          <li class="nav-item"><a class="nav-link" href="events.html"><i class="bi bi-calendar-event-fill"></i> Events</a></li>
          <li class="nav-item"><a class="nav-link" href="logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1><i class="bi bi-megaphone-fill"></i> Announcements</h1>
    </div>

    <div class="row mb-4">
      <div class="col-12">
        <a id="createBtn" href="create-announcement.html" class="btn btn-primary" style="display:none">+ Create Announcement</a>
        <a href="dashboard.html" class="btn btn-outline">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <div id="list" class="card-grid">
      <div class="card text-center" style="grid-column:1/-1">
        <div class="loading">Loading announcements</div>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>&copy; 2026 BBJ Digital Church Manager. All rights reserved.</p>
  </div>

  <script src="lib/bootstrap/bootstrap.bundle.min.js"></script>
  <script>
    let userRole = 'member'; // default
    
    // Get user role from session
    fetch('member-info').then(r => r.json()).then(j => {
      if (j.role) {
        userRole = j.role;
        // Show create button only for admins
        if (userRole === 'admin') {
          document.getElementById('createBtn').style.display = 'inline-block';
        }
      }
    }).catch(e => console.log('Could not fetch role'));
    
    fetch('announcements?action=list').then(r=>r.json()).then(j=>{
      const container=document.getElementById('list');
      if(j.announcements && j.announcements.length > 0){ 
        container.innerHTML = j.announcements.map(a=>`
          <div class="card">
            <h3>${a.title}</h3>
            <p>${a.content}</p>
            <small>${new Date(a.created_at).toLocaleDateString()}</small>
            ${userRole === 'admin' ? `<button onclick="deleteAnnouncement(${a.id})" class="btn btn-danger btn-sm mt-2">üóëÔ∏è Delete</button>` : ''}
          </div>
        `).join(''); 
      } else { 
        container.innerHTML = '<div class="card" style="grid-column:1/-1"><div style="text-align:center;color:#999;padding:2rem">No announcements yet</div></div>';
      }
    }).catch(e=>{document.getElementById('list').innerHTML='<div class="card alert alert-danger" style="grid-column:1/-1">Failed to load announcements</div>';});
    
    function deleteAnnouncement(id) {
      if (confirm('Are you sure you want to delete this announcement?')) {
        fetch('announcements', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: `action=delete&id=${id}`
        }).then(r => r.json()).then(j => {
          if (j.success) {
            alert('‚úì Announcement deleted');
            location.reload();
          } else {
            alert('‚úó Error: ' + (j.error || 'Unknown error'));
          }
        }).catch(e => alert('‚úó Error: ' + e.message));
      }
    }
  </script>
</body>
</html>
